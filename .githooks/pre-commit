#!/bin/sh
# Pre-commit hook for gpq-tiles
# Runs cargo fmt check, version consistency check, and syncs READMEs before allowing commit

echo "Running cargo fmt check..."
if ! cargo fmt --all -- --check 2>/dev/null; then
    echo ""
    echo "ERROR: Code is not formatted. Run 'cargo fmt --all' to fix."
    echo ""
    exit 1
fi
echo "Format check passed!"

# Check version consistency across workspace
echo "Checking version consistency..."
WORKSPACE_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
CORE_DEP_VERSION=$(grep 'gpq-tiles-core.*version' Cargo.toml | sed 's/.*version = "\([^"]*\)".*/\1/')

if [ -n "$CORE_DEP_VERSION" ] && [ "$WORKSPACE_VERSION" != "$CORE_DEP_VERSION" ]; then
    echo ""
    echo "ERROR: Version mismatch detected!"
    echo "  workspace.package.version = $WORKSPACE_VERSION"
    echo "  gpq-tiles-core dependency = $CORE_DEP_VERSION"
    echo ""
    echo "Update the gpq-tiles-core version in workspace.dependencies to match."
    echo "Or use 'cz bump' which handles this automatically."
    echo ""
    exit 1
fi

# Verify cargo can resolve dependencies (catches version mismatches)
if ! cargo metadata --format-version=1 >/dev/null 2>&1; then
    echo ""
    echo "ERROR: Cargo dependency resolution failed!"
    echo "Run 'cargo check' to see the detailed error."
    echo ""
    exit 1
fi
echo "Version consistency check passed!"

# Sync READMEs to subcrates
echo "Syncing README.md to subcrates..."
cp README.md crates/core/README.md
cp README.md crates/cli/README.md
cp README.md crates/python/README.md
git add crates/core/README.md crates/cli/README.md crates/python/README.md 2>/dev/null || true
echo "READMEs synced!"
