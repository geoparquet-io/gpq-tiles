#!/bin/sh
# Pre-commit hook for gpq-tiles
# Runs cargo fmt, clippy, version consistency check, and syncs READMEs before allowing commit

set -e

echo "Running cargo fmt check..."
if ! cargo fmt --all -- --check 2>/dev/null; then
    echo ""
    echo "ERROR: Code is not formatted. Run 'cargo fmt --all' to fix."
    echo ""
    exit 1
fi
echo "Format check passed!"

echo "Running cargo clippy..."
if ! cargo clippy --all-targets --all-features -- -D warnings 2>&1 | tail -20; then
    echo ""
    echo "ERROR: Clippy found issues. Fix them before committing."
    echo ""
    exit 1
fi
echo "Clippy check passed!"

# Check version consistency across workspace
echo "Checking version consistency..."
WORKSPACE_VERSION=$(grep -m1 '^version = ' Cargo.toml | sed 's/version = "\(.*\)"/\1/')
CORE_DEP_VERSION=$(grep 'gpq-tiles-core.*version' Cargo.toml | sed 's/.*version = "\([^"]*\)".*/\1/')
PYTHON_VERSION=$(grep -m1 '^version = ' crates/python/pyproject.toml | sed 's/version = "\(.*\)"/\1/')

VERSION_ERROR=0

if [ -n "$CORE_DEP_VERSION" ] && [ "$WORKSPACE_VERSION" != "$CORE_DEP_VERSION" ]; then
    echo ""
    echo "ERROR: Cargo version mismatch!"
    echo "  workspace.package.version = $WORKSPACE_VERSION"
    echo "  gpq-tiles-core dependency = $CORE_DEP_VERSION"
    VERSION_ERROR=1
fi

if [ -n "$PYTHON_VERSION" ] && [ "$WORKSPACE_VERSION" != "$PYTHON_VERSION" ]; then
    echo ""
    echo "ERROR: Python version mismatch!"
    echo "  workspace.package.version = $WORKSPACE_VERSION"
    echo "  pyproject.toml version     = $PYTHON_VERSION"
    VERSION_ERROR=1
fi

if [ "$VERSION_ERROR" -eq 1 ]; then
    echo ""
    echo "Fix: Run 'uv run cz bump --dry-run' to see what cz bump would update,"
    echo "     or manually sync versions in Cargo.toml and pyproject.toml."
    echo ""
    exit 1
fi

# Verify cargo can resolve dependencies (catches version mismatches)
if ! cargo metadata --format-version=1 >/dev/null 2>&1; then
    echo ""
    echo "ERROR: Cargo dependency resolution failed!"
    echo "Run 'cargo check' to see the detailed error."
    echo ""
    exit 1
fi
echo "Version consistency check passed!"

# Sync READMEs to subcrates
echo "Syncing README.md to subcrates..."
cp README.md crates/core/README.md
cp README.md crates/cli/README.md
cp README.md crates/python/README.md
git add crates/core/README.md crates/cli/README.md crates/python/README.md 2>/dev/null || true
echo "READMEs synced!"
